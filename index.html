<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿¡å·å®éªŒå®¤ - Signal Lab</title>
    <!-- 1. ä½¿ç”¨å›½å†…æœ€å¿«çš„ 360 é•œåƒåº“ï¼Œç¡®ä¿åº“èƒ½ç§’åŠ è½½ -->
    <script src="https://lib.baomitu.com/supabase/2.39.7/supabase-js.js"></script>
    <style>
        :root { --primary: #8a2be2; --accent: #ff00ff; --bg: #0f0c29; --glass: rgba(255, 255, 255, 0.1); }
        body { margin: 0; padding: 0; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); font-family: -apple-system, sans-serif; color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .navbar { width: 100%; padding: 20px 0; text-align: center; background: var(--glass); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; }
        .container { width: 92%; max-width: 450px; margin-top: 20px; padding-bottom: 50px; }
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 25px; margin-bottom: 25px; }
        .form-input, .form-select { width: 100%; padding: 14px; margin-bottom: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: #fff; outline: none; box-sizing: border-box; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-item { padding: 6px 14px; border-radius: 20px; font-size: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); cursor: pointer; }
        .tag-item.active { background: var(--primary); border-color: var(--accent); }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; color: #fff; }
        .btn-submit { background: linear-gradient(90deg, #8a2be2, #ff00ff); }
        .btn-draw-male { background: #4facfe; margin-bottom: 15px; }
        .btn-draw-female { background: #fa709a; }
        .result-box { display: none; text-align: center; margin-top: 20px; padding: 20px; border-radius: 20px; background: rgba(255,255,255,0.15); }
        .res-mbti { background: #ff00ff; padding: 2px 8px; border-radius: 5px; font-size: 12px; margin-left: 10px; }
        .res-contact { margin-top: 15px; padding: 15px; background: #fff; color: #000; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="navbar">
    <h1>ğŸ§© ä¿¡å·å®éªŒå®¤</h1>
    <p style="font-size:12px; opacity:0.8;">å·²æ•è· <span id="totalCount" style="color:#00f2fe">...</span> ä¸ªé¢‘ç‡ä¿¡å·</p>
</div>

<div class="container">
    <div class="card">
        <div style="font-weight:bold; margin-bottom:15px;">ğŸ“¡ å‘å°„ä½ çš„ä¿¡å·</div>
        <input type="text" id="nickname" class="form-input" placeholder="ä»£å· (æ˜µç§°)">
        <div style="display: flex; gap: 10px;">
            <select id="gender" class="form-select" style="flex:1"><option value="ç”·">ç”·ç”Ÿ ğŸ‘¦</option><option value="å¥³">å¥³ç”Ÿ ğŸ‘§</option></select>
            <input type="number" id="age" class="form-input" style="flex:1" placeholder="å¹´é¾„">
        </div>
        <input type="text" id="city" class="form-input" placeholder="æ‰€åœ¨åŸå¸‚">
        <select id="mbti" class="form-select">
            <option value="">é€‰æ‹©ä½ çš„ MBTI äººæ ¼</option>
            <option value="INFP">INFP è°ƒåœè€…</option><option value="ENFP">ENFP ç«é€‰è€…</option>
            <option value="INFJ">INFJ æå€¡è€…</option><option value="ENFJ">ENFJ ä¸»äººå…¬</option>
            <option value="INTJ">INTJ å»ºç­‘å¸ˆ</option><option value="ENTJ">ENTJ æŒ‡æŒ¥å®˜</option>
            <option value="INTP">INTP é€»è¾‘å­¦å®¶</option><option value="ENTP">ENTP è¾©è®ºå®¶</option>
            <option value="ISFP">ISFP è‰ºæœ¯å®¶</option><option value="ESFP">ESFP è¡¨æ¼”è€…</option>
            <option value="ISTP">ISTP é‰´èµå®¶</option><option value="ESTP">ESTP ä¼ä¸šå®¶</option>
            <option value="ISFJ">ISFJ å®ˆå«è€…</option><option value="ESFJ">ESFJ æ‰§æ”¿å®˜</option>
            <option value="ISTJ">ISTJ ç‰©æµå¸ˆ</option><option value="ESTJ">ESTJ æ€»ç®¡</option>
        </select>
        <div class="tag-container" id="tagPicker">
            <div class="tag-item">ç¤¾ç‰›</div><div class="tag-item">ç¤¾æ</div>
            <div class="tag-item">æ¸¸æˆå¤§ä½¬</div><div class="tag-item">çº¯çˆ±æˆ˜ç¥</div>
            <div class="tag-item">ç†¬å¤œå† å†›</div><div class="tag-item">æç¬‘ç”·/å¥³</div>
        </div>
        <input type="text" id="contact" class="form-input" placeholder="å¾®ä¿¡å· (å¿…å¡«)">
        <button class="btn btn-submit" onclick="submitCard()">å‘å°„ä¿¡å·</button>
    </div>

    <div class="card">
        <div style="font-weight:bold; margin-bottom:15px;">ğŸ” æ•æ‰åŒé¢‘ä¿¡å·</div>
        <button class="btn btn-draw-male" onclick="drawCard('ç”·')">æ•æ‰ç”·ç”Ÿ ğŸ‘¦</button>
        <button class="btn btn-draw-female" onclick="drawCard('å¥³')">æ•æ‰å¥³ç”Ÿ ğŸ‘§</button>
        <div id="resultArea" class="result-box">
            <div style="font-size: 40px;">ğŸ›¸</div>
            <div style="font-size: 20px; font-weight: bold; margin: 10px 0;">
                <span id="resNick">ä»£å·</span><span id="resMbti" class="res-mbti">MBTI</span>
            </div>
            <div id="resInfo" style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">--å² | --</div>
            <div id="resTags" class="tag-container" style="justify-content: center;"></div>
            <div class="res-contact" id="resContact" onclick="copyContact()">ç‚¹å‡»å¤åˆ¶å¾®ä¿¡å·</div>
        </div>
    </div>
</div>

<script>
    // --- è„šæœ¬å¼€å§‹ ---
    let client;
    let selectedTags = [];

    // åˆå§‹åŒ– Supabase
    function initSupabase() {
        if (typeof supabase === 'undefined') {
            console.error("åº“è¿˜æ²¡åŠ è½½å¥½ï¼Œç­‰å¾…ä¸­...");
            setTimeout(initSupabase, 500);
            return;
        }
        const SUPABASE_URL = 'https://jbyljemznjnqrixyohms.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_DI6RRfMXVspDzfnAkV61og_qpmnjmYg';
        client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        loadCount();
    }

    // åŠ è½½äººæ•°
    async function loadCount() {
        const { count, error } = await client.from('users').select('*', { count: 'exact', head: true });
        if (!error) document.getElementById('totalCount').innerText = (count || 0) + 548;
    }

    // æ ‡ç­¾ç‚¹å‡»
    document.querySelectorAll('.tag-item').forEach(item => {
        item.onclick = () => {
            item.classList.toggle('active');
            const tag = item.innerText;
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
            } else {
                selectedTags.push(tag);
            }
        };
    });

    // æäº¤
    async function submitCard() {
        const data = {
            nickname: document.getElementById('nickname').value.trim(),
            gender: document.getElementById('gender').value,
            age: document.getElementById('age').value,
            city: document.getElementById('city').value,
            mbti: document.getElementById('mbti').value,
            tags: selectedTags.join(','),
            contact: document.getElementById('contact').value.trim()
        };
        if (!data.nickname || !data.contact || !data.mbti) return alert('è¯·å¡«å¥½æ˜µç§°ã€MBTIå’Œå¾®ä¿¡å·ï¼');
        
        const { error } = await client.from('users').insert([data]);
        if (error && error.code === '23505') {
            alert('ğŸ‰ ä½ å·²ç»åœ¨ä¿¡å·æ± é‡Œå•¦ï¼å¯ä»¥ç›´æ¥å»æ•æ‰ã€‚');
        } else if (error) {
            alert('é”™è¯¯ï¼š' + error.message);
        } else {
            alert('âœ… å‘å°„æˆåŠŸï¼');
            loadCount();
        }
        localStorage.setItem('hasRegistered', 'true');
        localStorage.setItem('myContact', data.contact);
    }

    // æŠ½å–
    async function drawCard(targetGender) {
        if (!localStorage.getItem('hasRegistered')) {
            alert('ğŸ”’ è¯·å…ˆå‘å°„ä½ çš„ä¿¡å·ï¼');
            return window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        const { data: users, error } = await client.from('users').select('*').eq('gender', targetGender).neq('contact', localStorage.getItem('myContact'));
        if (error || !users?.length) return alert('æš‚æ— åŒé¢‘ä¿¡å·');

        const lucky = users[Math.floor(Math.random() * users.length)];
        document.getElementById('resNick').innerText = lucky.nickname;
        document.getElementById('resMbti').innerText = lucky.mbti;
        document.getElementById('resInfo').innerText = `${lucky.age}å² | ${lucky.city}`;
        document.getElementById('resContact').innerText = `å¤åˆ¶å¾®ä¿¡å·ï¼š${lucky.contact}`;
        document.getElementById('resContact').dataset.content = lucky.contact;
        document.getElementById('resultArea').style.display = 'block';
    }

    // å¤åˆ¶
    function copyContact() {
        const text = document.getElementById('resContact').dataset.content;
        const input = document.createElement("textarea");
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('âœ… å¤åˆ¶æˆåŠŸï¼Œå¿«å»åŠ å¾®ä¿¡å§ï¼');
    }

    // é¡µé¢åŠ è½½å®Œå¯åŠ¨
    window.onload = initSupabase;
</script>
</body>
</html>
