<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿¡å·å®éªŒå®¤ - Signal Lab</title>
    <!-- å¼•å…¥ Supabase å®˜æ–¹åº“ (ä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿ) -->
    <script src="https://lib.baomitu.com/supabase/2.39.7/supabase-js.js"></script>
    <style>
        :root { --primary: #8a2be2; --accent: #ff00ff; --glass: rgba(255, 255, 255, 0.1); }
        body { margin: 0; padding: 0; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); font-family: 'PingFang SC', -apple-system, sans-serif; color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .navbar { width: 100%; padding: 20px 0; text-align: center; background: var(--glass); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .container { width: 92%; max-width: 450px; margin-top: 20px; padding-bottom: 50px; }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .card-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; }
        
        /* è¡¨å•æ§ä»¶ */
        .form-input, .form-select { width: 100%; padding: 14px; margin-bottom: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: #fff; font-size: 15px; outline: none; box-sizing: border-box; transition: 0.3s; }
        .form-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
        
        /* æ ‡ç­¾é€‰æ‹©å™¨ */
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-item { padding: 6px 14px; border-radius: 20px; font-size: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: 0.3s; }
        .tag-item.active { background: var(--primary); border-color: var(--accent); box-shadow: 0 0 10px var(--primary); }

        /* æŒ‰é’® */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; color: #fff; margin-bottom: 10px; }
        .btn-submit { background: linear-gradient(90deg, #8a2be2, #ff00ff); }
        .btn-draw-male { background: #4facfe; }
        .btn-draw-female { background: #fa709a; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ç»“æœåŒºåŸŸ */
        .result-box { display: none; text-align: center; margin-top: 20px; padding: 25px; border-radius: 24px; background: rgba(255,255,255,0.15); border: 2px dashed rgba(255,255,255,0.3); animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .res-mbti { background: var(--accent); color: white; padding: 2px 8px; border-radius: 6px; font-size: 12px; margin-left: 8px; }
        .res-contact { margin-top: 15px; padding: 15px; background: #fff; color: #302b63; border-radius: 12px; font-weight: bold; cursor: pointer; word-break: break-all; }
        
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <h1>ğŸ“¡ ä¿¡å·å®éªŒå®¤</h1>
    <p style="font-size:12px; opacity:0.8; margin-top:5px;">å·²æ•è· <span id="totalCount" style="color:#00f2fe; font-weight:bold;">...</span> ä¸ªåŒé¢‘ä¿¡å·</p>
</div>

<div class="container">
    <!-- 1. å‘å°„ä¿¡å·å¡ç‰‡ -->
    <div class="card">
        <div class="card-title">ğŸ›¸ å‘å°„ä½ çš„ä¿¡å·</div>
        <input type="text" id="nickname" class="form-input" placeholder="æ€ä¹ˆç§°å‘¼ä½ ï¼Ÿ">
        <div style="display: flex; gap: 10px;">
            <select id="gender" class="form-select" style="flex:1"><option value="ç”·">ç”·ç”Ÿ ğŸ‘¦</option><option value="å¥³">å¥³ç”Ÿ ğŸ‘§</option></select>
            <input type="number" id="age" class="form-input" style="flex:1" placeholder="å¹´é¾„">
        </div>
        <input type="text" id="city" class="form-input" placeholder="æ‰€åœ¨åŸå¸‚">
        <select id="mbti" class="form-select">
            <option value="">é€‰æ‹©ä½ çš„ MBTI</option>
            <option value="INFP">INFP è°ƒåœè€…</option><option value="ENFP">ENFP ç«é€‰è€…</option>
            <option value="INFJ">INFJ æå€¡è€…</option><option value="ENFJ">ENFJ ä¸»äººå…¬</option>
            <option value="INTJ">INTJ å»ºç­‘å¸ˆ</option><option value="ENTJ">ENTJ æŒ‡æŒ¥å®˜</option>
            <option value="INTP">INTP é€»è¾‘å­¦å®¶</option><option value="ENTP">ENTP è¾©è®ºå®¶</option>
            <option value="ISFP">ISFP è‰ºæœ¯å®¶</option><option value="ESFP">ESFP è¡¨æ¼”è€…</option>
            <option value="ISTP">ISTP é‰´èµå®¶</option><option value="ESTP">ESTP ä¼ä¸šå®¶</option>
            <option value="ISFJ">ISFJ å®ˆå«è€…</option><option value="ESFJ">ESFJ æ‰§æ”¿å®˜</option>
            <option value="ISTJ">ISTJ ç‰©æµå¸ˆ</option><option value="ESTJ">ESTJ æ€»ç®¡</option>
        </select>
        <div class="tag-container" id="tagPicker">
            <div class="tag-item">ç¤¾ç‰›</div><div class="tag-item">ç¤¾æ</div>
            <div class="tag-item">çº¯çˆ±æˆ˜ç¥</div><div class="tag-item">ç†¬å¤œå† å†›</div>
            <div class="tag-item">æ¸¸æˆå¤§ä½¬</div><div class="tag-item">æç¬‘å¥³/ç”·</div>
        </div>
        <input type="text" id="contact" class="form-input" placeholder="å¾®ä¿¡å· (éå¸¸é‡è¦)">
        <button class="btn btn-submit" id="submitBtn" onclick="submitCard()">å‘å°„ä¿¡å·ï¼Œåç­‰ç¼˜åˆ†</button>
    </div>

    <!-- 2. æ•æ‰ä¿¡å·å¡ç‰‡ -->
    <div class="card">
        <div class="card-title">ğŸ” æ•æ‰åŒé¢‘ä¿¡å·</div>
        <button class="btn btn-draw-male" onclick="drawCard('ç”·')">æ•æ‰ç”·ç”Ÿä¿¡å· ğŸ‘¦</button>
        <button class="btn btn-draw-female" onclick="drawCard('å¥³')">æ•æ‰å¥³ç”Ÿä¿¡å· ğŸ‘§</button>
        
        <div id="resultArea" class="result-box">
            <div style="font-size: 50px;">âœ¨</div>
            <div style="font-size: 20px; font-weight: bold; margin: 10px 0;">
                <span id="resNick">ä»£å·</span><span id="resMbti" class="res-mbti">MBTI</span>
            </div>
            <div id="resInfo" style="font-size: 14px; opacity: 0.8; margin-bottom: 12px;">--å² | --</div>
            <div id="resTags" class="tag-container" style="justify-content: center;"></div>
            <div class="res-contact" id="resContact" onclick="copyContact()">ç‚¹å‡»å¤åˆ¶å¾®ä¿¡å·</div>
            <p style="font-size:11px; opacity:0.6; margin-top:10px;">æ¸©é¦¨æç¤ºï¼šå¯¹æ–¹ä¹Ÿåœ¨ç­‰ä½ å‘å°„ä¿¡å·å“¦</p>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½®åŒº ---
    const SUPABASE_URL = 'https://jbyljemznjnqrixyohms.supabase.co';
    // â¬‡ï¸ è¿™é‡Œå¡«å…¥ä½ åˆšæ‰ Copy çš„é‚£ä¸ªä»¥ eyJ å¼€å¤´çš„æé•¿ Key
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpieWxqZW16bmpucXJpeHlvaG1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODcwNzksImV4cCI6MjA4MTU2MzA3OX0.Nyuc_K0tuqGM6uSm9TvCK2fDQuTq7ZzVBI4fJ7GwVUg'; 

    let client;
    let selectedTags = [];

    // åˆå§‹åŒ–è¿æ¥
    function init() {
        if (typeof supabase === 'undefined') {
            return setTimeout(init, 500);
        }
        client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        loadCount();
    }

    // ç»Ÿè®¡äººæ•°
    async function loadCount() {
        try {
            const { count, error } = await client.from('users').select('*', { count: 'exact', head: true });
            if (!error) document.getElementById('totalCount').innerText = (count || 0) + 548;
        } catch (e) { console.error("åŠ è½½äººæ•°å¤±è´¥"); }
    }

    // æ ‡ç­¾å¤šé€‰é€»è¾‘
    document.querySelectorAll('.tag-item').forEach(item => {
        item.onclick = () => {
            item.classList.toggle('active');
            const tag = item.innerText;
            if (selectedTags.includes(tag)) selectedTags = selectedTags.filter(t => t !== tag);
            else selectedTags.push(tag);
        };
    });

    // --- æäº¤å‡½æ•° (å·²ä¿®å¤å¡é¡¿å’Œç±»å‹é—®é¢˜) ---
    async function submitCard() {
        const btn = document.getElementById('submitBtn');
        const rawAge = document.getElementById('age').value;
        
        const data = {
            nickname: document.getElementById('nickname').value.trim(),
            gender: document.getElementById('gender').value,
            age: rawAge ? parseInt(rawAge) : 0, // å¼ºåˆ¶è½¬ä¸ºæ•´æ•°ï¼ŒåŒ¹é…æ•°æ®åº“ int8
            city: document.getElementById('city').value.trim(),
            mbti: document.getElementById('mbti').value,
            tags: selectedTags.join(','),
            contact: document.getElementById('contact').value.trim()
        };

        if (!data.nickname || !data.contact || !data.mbti) {
            return alert('è¯·å¡«å¥½ä»£å·ã€MBTI å’Œå¾®ä¿¡å·å“¦ï¼');
        }

        btn.disabled = true;
        btn.innerText = 'æ­£åœ¨å‘å°„ä¿¡å·...';

        try {
            const { error } = await client.from('users').insert([data]);
            if (error) {
                console.error("æäº¤å¤±è´¥:", error);
                if (error.code === '42501') {
                    alert("ğŸš« æƒé™ä¸è¶³ï¼è¯·åœ¨ Supabase åå°å¼€å¯ RLS Policy (å…è®¸æ‰€æœ‰äºº Insert)ã€‚");
                } else {
                    alert("å‘å°„å¤±è´¥ï¼š" + error.message);
                }
            } else {
                alert("âœ… ä¿¡å·å·²æˆåŠŸå‘å°„è‡³æ˜Ÿç©ºï¼");
                localStorage.setItem('hasRegistered', 'true');
                localStorage.setItem('myContact', data.contact);
                loadCount();
            }
        } catch (err) {
            alert("ç½‘ç»œè¿æ¥è¶…æ—¶æˆ–ç³»ç»Ÿå¼‚å¸¸");
        } finally {
            btn.disabled = false;
            btn.innerText = 'å‘å°„ä¿¡å·ï¼Œåç­‰ç¼˜åˆ†';
        }
    }

    // --- æ•æ‰å‡½æ•° ---
    async function drawCard(targetGender) {
        if (!localStorage.getItem('hasRegistered')) {
            alert("ğŸ”’ ä¸ºäº†å…¬å¹³èµ·è§ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹â€œå‘å°„ä¿¡å·â€åæ‰èƒ½æ•æ‰åˆ«äººå“¦ï¼");
            return window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const myContact = localStorage.getItem('myContact');
        
        try {
            const { data, error } = await client.from('users').select('*').eq('gender', targetGender).neq('contact', myContact);
            if (error || !data?.length) return alert("å½“å‰é¢‘é“æš‚æ— æ›´å¤šä¿¡å·ï¼Œæ¢ä¸ªæ€§åˆ«è¯•è¯•ï¼Ÿ");

            // éšæœºé€‰ä¸€ä¸ª
            const lucky = data[Math.floor(Math.random() * data.length)];
            
            // æ¸²æŸ“ç»“æœ
            document.getElementById('resNick').innerText = lucky.nickname;
            document.getElementById('resMbti').innerText = lucky.mbti || '??';
            document.getElementById('resInfo').innerText = `${lucky.age}å² | ${lucky.city}`;
            document.getElementById('resContact').innerText = `å¤åˆ¶å¾®ä¿¡å·ï¼š${lucky.contact}`;
            document.getElementById('resContact').dataset.content = lucky.contact;
            
            // æ¸²æŸ“æ ‡ç­¾
            const tagArea = document.getElementById('resTags');
            tagArea.innerHTML = '';
            if(lucky.tags) lucky.tags.split(',').forEach(t => {
                const s = document.createElement('span'); 
                s.className = 'tag-item active'; 
                s.innerText = t; 
                s.style.fontSize = '10px';
                tagArea.appendChild(s);
            });

            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            alert("ä¿¡å·æ•æ‰ä¸­æ–­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        }
    }

    // å¤åˆ¶åŠŸèƒ½
    function copyContact() {
        const text = document.getElementById('resContact').dataset.content;
        const input = document.createElement("textarea");
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('âœ… ä¿¡å·å·²é”å®šï¼Œå¾®ä¿¡å·å¤åˆ¶æˆåŠŸï¼');
    }

    window.onload = init;
</script>
</body>
</html>
