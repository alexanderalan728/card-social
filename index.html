<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿¡å·å®éªŒå®¤ - Signal Lab</title>
    <!-- å¼•å…¥å›½å†…æœ€ç¨³å®šçš„ Supabase åº“é•œåƒ -->
    <script src="https://lib.baomitu.com/supabase/2.39.7/supabase-js.js"></script>
    <style>
        :root { --primary: #8a2be2; --accent: #ff00ff; --glass: rgba(255, 255, 255, 0.1); }
        body { margin: 0; padding: 0; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); font-family: 'PingFang SC', sans-serif; color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .navbar { width: 100%; padding: 25px 0; text-align: center; background: var(--glass); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .container { width: 92%; max-width: 450px; margin-top: 25px; padding-bottom: 60px; }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 28px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .card-title { font-size: 19px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; letter-spacing: 1px; }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .form-input, .form-select { width: 100%; padding: 15px; margin-bottom: 18px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); border-radius: 15px; color: #fff; font-size: 15px; outline: none; box-sizing: border-box; transition: 0.3s; }
        .form-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
        
        /* æ ‡ç­¾äº‘é€‰æ‹© */
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .tag-item { padding: 7px 16px; border-radius: 25px; font-size: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); cursor: pointer; transition: 0.3s; }
        .tag-item.active { background: var(--primary); border-color: var(--accent); box-shadow: 0 0 15px rgba(138, 43, 226, 0.5); transform: scale(1.05); }

        /* æŒ‰é’®è®¾è®¡ */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 18px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; color: #fff; margin-bottom: 15px; }
        .btn-submit { background: linear-gradient(90deg, #8a2be2, #ff00ff); box-shadow: 0 5px 20px rgba(138, 43, 226, 0.4); }
        .btn-draw-male { background: #00d2ff; }
        .btn-draw-female { background: #ff758c; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ç»“æœåŒºåŸŸ */
        .result-box { display: none; text-align: center; margin-top: 25px; padding: 30px; border-radius: 28px; background: rgba(255,255,255,0.12); border: 2px dashed rgba(255,255,255,0.2); animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .res-mbti { background: #00f2fe; color: #000; padding: 3px 10px; border-radius: 8px; font-size: 13px; font-weight: bold; margin-left: 10px; }
        .res-contact { margin-top: 20px; padding: 18px; background: #fff; color: #1a1a2e; border-radius: 15px; font-weight: 900; cursor: pointer; font-size: 18px; word-break: break-all; }
        
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <h1 style="margin:0; font-size:22px; letter-spacing:3px;">ğŸ›°ï¸ ä¿¡å·å®éªŒå®¤</h1>
    <p style="font-size:12px; opacity:0.7; margin-top:8px;">å·²æ•æ‰ <span id="totalCount" style="color:#00f2fe; font-weight:bold;">...</span> ä¸ªåŒé¢‘ä¿¡å·</p>
</div>

<div class="container">
    <!-- æ¨¡å—ä¸€ï¼šå‘å°„é¢‘ç‡ -->
    <div class="card">
        <div class="card-title">ğŸ›¸ å‘å°„ä½ çš„ä¿¡å·</div>
        <input type="text" id="nickname" class="form-input" placeholder="è¾“å…¥ä»£å· (æ˜µç§°)">
        <div style="display: flex; gap: 12px;">
            <select id="gender" class="form-select" style="flex:1"><option value="ç”·">ç”·ç”Ÿ ğŸ‘¦</option><option value="å¥³">å¥³ç”Ÿ ğŸ‘§</option></select>
            <input type="number" id="age" class="form-input" style="flex:1" placeholder="å¹´é¾„">
        </div>
        <input type="text" id="city" class="form-input" placeholder="åæ ‡åŸå¸‚">
        <select id="mbti" class="form-select">
            <option value="">é€‰æ‹©ä½ çš„ MBTI äººæ ¼</option>
            <option value="INFP">INFP è°ƒåœè€…</option><option value="ENFP">ENFP ç«é€‰è€…</option>
            <option value="INFJ">INFJ æå€¡è€…</option><option value="ENFJ">ENFJ ä¸»äººå…¬</option>
            <option value="INTJ">INTJ å»ºç­‘å¸ˆ</option><option value="ENTJ">ENTJ æŒ‡æŒ¥å®˜</option>
            <option value="INTP">INTP é€»è¾‘å­¦å®¶</option><option value="ENTP">ENTP è¾©è®ºå®¶</option>
            <option value="ISFP">ISFP è‰ºæœ¯å®¶</option><option value="ESFP">ESFP è¡¨æ¼”è€…</option>
            <option value="ISTP">ISTP é‰´èµå®¶</option><option value="ESTP">ESTP ä¼ä¸šå®¶</option>
            <option value="ISFJ">ISFJ å®ˆå«è€…</option><option value="ESFJ">ESFJ æ‰§æ”¿å®˜</option>
            <option value="ISTJ">ISTJ ç‰©æµå¸ˆ</option><option value="ESTJ">ESTJ æ€»ç®¡</option>
        </select>
        
        <div class="tag-container" id="tagPicker">
            <div class="tag-item">çº¯çˆ±æˆ˜ç¥</div><div class="tag-item">ç¤¾æ</div>
            <div class="tag-item">ç¤¾ç‰›</div><div class="tag-item">ç†¬å¤œå† å†›</div>
            <div class="tag-item">æ¸¸æˆå¤§ä½¬</div><div class="tag-item">æç¬‘å¥³/ç”·</div>
            <div class="tag-item">ç½‘ç˜¾å°‘å¹´</div><div class="tag-item">å¥èº«è¾¾äºº</div>
        </div>

        <input type="text" id="contact" class="form-input" placeholder="å¾®ä¿¡å· (å¿…å¡«ï¼Œä»…å¯¹æ–¹å¯è§)">
        <button class="btn btn-submit" id="submitBtn" onclick="submitCard()">åŒæ­¥é¢‘ç‡ï¼Œè¿›å…¥ä¿¡å·æ± </button>
    </div>

    <!-- æ¨¡å—äºŒï¼šæ•æ‰é¢‘ç‡ -->
    <div class="card">
        <div class="card-title">ğŸ” æ•æ‰åŒé¢‘é¢‘ç‡</div>
        <button class="btn btn-draw-male" onclick="drawCard('ç”·')">æ•æ‰ç”·ç”Ÿé¢‘ç‡ ğŸ‘¦</button>
        <button class="btn btn-draw-female" onclick="drawCard('å¥³')">æ•æ‰å¥³ç”Ÿé¢‘ç‡ ğŸ‘§</button>
        
        <div id="resultArea" class="result-box">
            <div style="font-size: 50px;">â˜„ï¸</div>
            <div style="font-size: 22px; font-weight: bold; margin: 15px 0;">
                <span id="resNick">æœªçŸ¥ä»£å·</span><span id="resMbti" class="res-mbti">MBTI</span>
            </div>
            <div id="resInfo" style="font-size: 15px; opacity: 0.8; margin-bottom: 15px;">--å² | --</div>
            <div id="resTags" class="tag-container" style="justify-content: center;"></div>
            <div class="res-contact" id="resContact" onclick="copyContact()">ç‚¹å‡»å¤åˆ¶å¾®ä¿¡å·</div>
            <p style="font-size:11px; opacity:0.5; margin-top:15px;">Tip: æˆåŠŸå¤åˆ¶åè¯·åŠæ—¶åœ¨å¾®ä¿¡æ·»åŠ å“¦</p>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® (å·²å¡«å…¥ä½ çš„çœŸå® Key) ---
    const SUPABASE_URL = 'https://jbyljemznjnqrixyohms.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpieWxqZW16bmpucXJpeHlvaG1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODcwNzksImV4cCI6MjA4MTU2MzA3OX0.Nyuc_K0tuqGM6uSm9TvCK2fDQuTq7ZzVBI4fJ7GwVUg'; 

    let client;
    let selectedTags = [];

    // åˆå§‹åŒ–è¿æ¥
    function init() {
        if (typeof supabase === 'undefined') return setTimeout(init, 500);
        client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        loadCount();
    }

    // ç»Ÿè®¡å®æ—¶ä¿¡å·
    async function loadCount() {
        try {
            const { count, error } = await client.from('users').select('*', { count: 'exact', head: true });
            if (!error) document.getElementById('totalCount').innerText = (count || 0) + 548;
        } catch (e) { console.warn("Syncing..."); }
    }

    // æ ‡ç­¾å¤šé€‰é€»è¾‘
    document.querySelectorAll('.tag-item').forEach(item => {
        item.onclick = () => {
            item.classList.toggle('active');
            const tag = item.innerText;
            if (selectedTags.includes(tag)) selectedTags = selectedTags.filter(t => t !== tag);
            else selectedTags.push(tag);
        };
    });

    // --- å‘å°„ä¿¡å· (å·²å¤„ç† Age ç±»å‹è½¬æ¢) ---
    async function submitCard() {
        const btn = document.getElementById('submitBtn');
        const rawAge = document.getElementById('age').value;
        
        const data = {
            nickname: document.getElementById('nickname').value.trim(),
            gender: document.getElementById('gender').value,
            age: rawAge ? parseInt(rawAge) : 0, // æ ¸å¿ƒï¼šè½¬ä¸ºæ•´æ•°åŒ¹é…æ•°æ®åº“
            city: document.getElementById('city').value.trim(),
            mbti: document.getElementById('mbti').value,
            tags: selectedTags.join(','),
            contact: document.getElementById('contact').value.trim()
        };

        if (!data.nickname || !data.contact || !data.mbti) return alert('ä»£å·ã€MBTI å’Œå¾®ä¿¡å·éƒ½è¦å¡«å“¦ï¼');

        btn.disabled = true;
        btn.innerText = 'æ­£åœ¨åŒæ­¥é¢‘ç‡...';

        try {
            const { error } = await client.from('users').insert([data]);
            if (error) {
                console.error(error);
                alert("å‘å°„å¤±è´¥ï¼åŸå› ï¼š" + error.message);
            } else {
                alert("âœ… é¢‘ç‡åŒæ­¥æˆåŠŸï¼");
                localStorage.setItem('hasRegistered', 'true');
                localStorage.setItem('myContact', data.contact);
                loadCount();
            }
        } catch (err) {
            alert("ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•");
        } finally {
            btn.disabled = false;
            btn.innerText = 'åŒæ­¥é¢‘ç‡ï¼Œè¿›å…¥ä¿¡å·æ± ';
        }
    }

    // --- æ•æ‰ä¿¡å· ---
    async function drawCard(targetGender) {
        if (!localStorage.getItem('hasRegistered')) {
            alert("ğŸ”’ è¯·å…ˆåœ¨ä¸Šæ–¹â€œå‘å°„ä¿¡å·â€å½•å…¥ä½ çš„é¢‘ç‡ï¼");
            return window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const myContact = localStorage.getItem('myContact');
        
        try {
            const { data, error } = await client.from('users').select('*').eq('gender', targetGender).neq('contact', myContact);
            if (error || !data?.length) return alert("å½“å‰é¢‘é“ä¿¡å·å¾®å¼±ï¼Œæ¢ä¸ªæ€§åˆ«æ•æ‰è¯•è¯•ï¼Ÿ");

            const lucky = data[Math.floor(Math.random() * data.length)];
            
            // UI æ¸²æŸ“
            document.getElementById('resNick').innerText = lucky.nickname;
            document.getElementById('resMbti').innerText = lucky.mbti || '??';
            document.getElementById('resInfo').innerText = `${lucky.age}å² | ${lucky.city}`;
            document.getElementById('resContact').innerText = `å¤åˆ¶å¾®ä¿¡å·ï¼š${lucky.contact}`;
            document.getElementById('resContact').dataset.content = lucky.contact;
            
            const tagArea = document.getElementById('resTags');
            tagArea.innerHTML = '';
            if(lucky.tags) lucky.tags.split(',').forEach(t => {
                const s = document.createElement('span'); 
                s.className = 'tag-item active'; 
                s.innerText = t; 
                s.style.fontSize = '11px';
                tagArea.appendChild(s);
            });

            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            alert("æ•æ‰ä¸­æ–­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        }
    }

    // å¤åˆ¶åŠŸèƒ½
    function copyContact() {
        const text = document.getElementById('resContact').dataset.content;
        const input = document.createElement("textarea");
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('âœ… ä¿¡å·é”å®šï¼Œå¾®ä¿¡å·å·²å¤åˆ¶ï¼');
    }

    window.onload = init;
</script>
</body>
</html>
